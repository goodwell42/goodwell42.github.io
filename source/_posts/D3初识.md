---
title: D3初识
date: 2019-06-26 15:28:05
tags: D3.js JavaScript
toc: true
categories: 
- JavaScript
- D3.js
---



`以一个简单的可视化分析系统为例，领略D3.js`

本文主要为记录D3.js笔记。

根据刘晖老师发的文档介绍的技术，通过查阅资料实现一个类似的简单的系统界面。

*笔记、项目代码托管于我的*[Github](https://github.com/goodwell42/VisualTest)

<!-- more -->

## 选择元素和绑定数据

### 选择元素

在 D3 中，用于选择元素的函数有两个：

- d3.select()：是选择所有指定元素的第一个
- d3.selectAll()：是选择指定元素的全部

这两个函数返回的结果称为选择集。

例如，选择集的常见用法如下。

```
var body = d3.select("body"); //选择文档中的body元素
var p1 = body.select("p"); //选择body中的第一个p元素
var p = body.selectAll("p"); //选择body中的所有p元素
var svg = body.select("svg"); //选择body中的svg元素
var rects = svg.selectAll("rect"); //选择svg中所有的svg元素
```

  选择集和绑定数据通常是一起使用的。

### 绑定数据

D3 有一个很独特的功能：能将数据绑定到 DOM 上，也就是绑定到文档上。

D3 中是通过以下两个函数来绑定数据的：

- datum()：绑定一个数据到选择集上
- data()：绑定一个数组到选择集上，数组的各项值分别与选择集的各元素绑定

相对而言，data() 比较常用。

假设现在有三个段落元素如下。

```
<p>Apple</p>
<p>Pear</p>
<p>Banana</p>
```

$$
1. datum()
$$

假设有一字符串 China，要将此字符串分别与三个段落元素绑定，代码如下：

```
var str = "China";

var body = d3.select("body");
var p = body.selectAll("p");

p.datum(str);

p.text(function(d, i){
return "第 "+ i + " 个元素绑定的数据是 " + d;
});
```

绑定数据后，使用此数据来修改三个段落元素的内容，其结果如下：

```
第 0 个元素绑定的数据是 China
第 1 个元素绑定的数据是 China
第 2 个元素绑定的数据是 China
```

在上面的代码中，用到了一个无名函数 function(d, i)。当选择集需要使用被绑定的数据时，常需要这么使用。其
包含两个参数，其中：

- d 代表数据，也就是与某元素绑定的数据。
- i 代表索引，代表数据的索引号，从 0 开始。
  例如，上述例子中：第 0 个元素 apple 绑定的数据是 China。

$$
2. data()
$$

有一个数组，接下来要分别将数组的各元素绑定到三个段落元素上。

```
var dataset = ["I like dog","I like cat","I like snake"];
```

绑定之后，其对应关系的要求为：

- Apple 与 I like dog 绑定
- Pear 与 I like cat 绑定
- Banana 与 I like snake 绑定

调用 data() 绑定数据，并替换三个段落元素的字符串为被绑定的字符串，代码如下：

```
var body = d3.select("body");
var p = body.selectAll("p");

p.data(dataset)
 .text(function(d, i){
return d;
});
```

这段代码也用到了一个无名函数 function(d, i)，其对应的情况如下：

- 当 i == 0 时， d 为 I like dog。
- 当 i == 1 时， d 为 I like cat。
- 当 i == 2 时， d 为 I like snake。

此时，三个段落元素与数组 dataset 的三个字符串是一一对应的，因此，在函数 function(d, i) 直接 return d 即
可。
结果自然是三个段落的文字分别变成了数组的三个字符串。

```
I like dog
I like cat
I like snake
```

### 插入元素

插入元素涉及的函数有两个：

- append()：在选择集末尾插入元素
- insert()：在选择集前面插入元素

假设有三个段落元素，与上文相同。
$$
3. append()
$$

```
body.append("p")
.text("append p element");
```

在 body 的末尾添加一个 p 元素，结果为：

```
Apple
Pear
Banana
append p element
```

$$
insert()
$$

在 body 中 id 为 myid 的元素前添加一个段落元素。

```
body.insert("p","#myid")
.text("insert p element");
```

已经指定了 Pear 段落的 id 为 myid，因此结果如下。

```
Apple
insert p element
Pear
Banana
```

### 删除元素

删除一个元素时，对于选择的元素，使用 remove 即可，例如：

```
var p = body.select("#myid");
p.remove();
```

如此即可删除指定 id 的段落元素.

## 比例尺的使用

将某一区域的值映射到另一区域，其大小关系不变，这就是比例尺（Scale）。

D3 中的比例尺，也有定义域和值域，分别被称为 domain 和 range。开发者需要指定 domain 和 range 的范
围，如此即可得到一个计算关系。

### 线性比例尺

线性比例尺，能将一个连续的区间，映射到另一区间。要解决柱形图宽度的问题，就需要线性比例尺。
假设有以下数组：

```
var dataset = [1.2, 2.3, 0.9, 1.5, 3.3];
```

现有要求如下：
将 dataset 中最小的值，映射成 0；将最大的值，映射成 300。
代码如下：

```
var min = d3.min(dataset);
var max = d3.max(dataset);
var linear = d3.scale.linear()
.domain([min, max])
.range([0, 300]);
linear(0.9); //返回 0
linear(2.3); //返回 175
linear(3.3); //返回 300
```

其中，) d3.scale.linear() 返回一个线性比例尺。domain() 和 range() 分别设定比例尺的定义域和值域。在这里
还用到了两个函数，它们经常与比例尺一起出现：

- d3.max()
- d3.min()

这两个函数能够求数组的最大值和最小值，是 D3 提供的。
有一点请大家记住：d3.scale.linear() 的返回值，是可以当做函数来使用的。因此，才有这样的用法：linear(0.9)。

### 序数比例尺

有时候，定义域和值域不一定是连续的。例如，有两个数组：

```
var index = [0, 1, 2, 3, 4];
var color = ["red", "blue", "green", "yellow", "black"];
```

我们希望 0 对应颜色 red，1 对应 blue，依次类推。
但是，这些值都是离散的，线性比例尺不适合，需要用到序数比例尺。

```
var ordinal = d3.scale.ordinal()
.domain(index)
.range(color);
ordinal(0); //返回 red
ordinal(2); //返回 green
ordinal(4); //返回 black
```

用法与线性比例尺是类似的。

### 给柱形图添加比例尺

在上一章的基础上，修改一下数组，再定义一个线性比例尺。

```
var dataset = [ 2.5 , 2.1 , 1.7 , 1.3 , 0.9 ];
var linear = d3.scale.linear()
.domain([0, d3.max(dataset)])
.range([0, 250]);
```

​	其后，按照上一章的方法添加矩形，在给矩形设置宽度的时候，应用比例尺。

```
var rectHeight = 25; //每个矩形所占的像素高度(包括空白)
svg.selectAll("rect")
.data(dataset)
.enter()
.append("rect")
.attr("x",20)
.attr("y",function(d,i){
return i * rectHeight;
})
.attr("width",function(d){
return linear(d); //在这里用比例尺
})
.attr("height",rectHeight-2)
.attr("fill","steelblue");
```

如此一来，所有的数值，都按照同一个线性比例尺的关系来计算宽度，因此数值之间的大小关系不变。

### 数据切片

